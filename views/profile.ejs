<style>
  #profile {
    margin-top: 0 !important;
  }

  .profile-page {
    display: flex;
    justify-content: center;
    padding: 4rem 1rem;
    /* background: var(--container-bg); */
  }

  .profile-header {
    display: flex;
    gap: 1rem;
    align-items: center;
    flex-wrap: wrap;
    background: var(--glass-bg) !important;
    padding: 2rem;
    border-radius: 30px;
  }

  .profile-card {
    background: var(--body-bg);
    padding: 2rem;
    border-radius: 1.5rem;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    max-width: 600px;
    width: 100%;
  }

  .banner-image {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    position: relative;
    width: 100%;
    height: 20vh;
    z-index: 0;
    border-radius: 30px;
  }

  .banner-overlay {
    /* display: none; */
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    height: 20vh;
    width: 100%;
    z-index: 0;
    border-radius: 30px;
  }

  #bannerImage {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: 50% 40%;
    /* horizontally center, vertically top */
    border-radius: 30px;
  }

  
  .profile-header {
    padding: 1rem;
    border-radius: 1rem;
    background: var(--bg-elevated);
    box-shadow: 0 6px 24px rgba(0, 0, 0, 0.1);
  }

  .avatar-status-wrap {
    margin-top: -4rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    flex-wrap: wrap;
    z-index: 5;
  }

  .avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background-color: var(--body-bg);
    flex-shrink: 0;
  }

    /* Profile Header */
    .avatar-profile {
    width: 95px;
    height: 95px;
  }


  .avatar-profile img.profile-pic {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid var(--primary-color);
    cursor: pointer;
    transition: transform 0.3s;
  }

  .profile-pic {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
    z-index: 0;
    border-radius: 50%;
    border: 3px solid var(--primary-color);
  }


  .profile-header .user {
    color: #fff !important;
  }


  .edit-icon {
    position: absolute;
    bottom: 5px;
    right: 5px;
    background: var(--primary-color);
    color: var(--button-text);
    border-radius: 50%;
    padding: 6px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: background 0.3s ease;
    z-index: 10;
  }

  .edit-icon:hover {
    background: var(--secondary-color);
  }


  .profile-info h2 {
    margin: 0;
    font-size: 1.8rem;
  }

  .profile-info .tagline {
    color: var(--text-muted);
    font-style: italic;
    margin-bottom: 1rem;
  }
  
  .quick-stats {
    display: flex;
    justify-content: space-around;
    align-items: center;
    gap: 1.5rem;
    margin: 1rem 0;
    text-align: center;
  }

  .stat {
    text-align: center;
    cursor: pointer;
  }


  .stat strong {
    display: block;
    font-size: 1.2rem;
  }

  .username-bundle {
    flex-grow: 1;
  }

  .username {
    font-size: 1.2rem;
    font-weight: bold;
  }

  .verified-badge {
    width: 16px;
    vertical-align: middle;
    margin-left: 0.25rem;
  }

  .user-bio {
    margin-top: 0.25rem;
    font-size: 0.95rem;
    color: var(--text-secondary);
  }

  .user-bio.empty {
    font-style: italic;
    color: var(--text-muted);
  }


  /* Buttons */
  .edit-profile-btn,
  .read-more,
  .edit-comment,
  .delete-comment {
    background: var(--primary-color);
    color: var(--text-color);
    border: none;
    border-radius: 8px;
    padding: 0.5rem 1rem;
    margin-top: 0.5rem;
    cursor: pointer;
    transition: background 0.3s ease;
  }

  
  .edit-profile-btn {
    position: absolute;
    top: .5rem;
    left: 1rem;
    z-index: 5;
    margin: 0;
    filter: brightness(150%);
    filter: contrast(150%);
    font-weight: bold;
    border: none;
    border-radius: 999px;
    cursor: pointer;
    transition: background 0.3s;
  }

  .eavedrop-btn {
    position: relative;
    margin: 0 !important;
    margin-left: -2.5rem !important;
  }

  .edit-profile-btn:hover,
  .read-more:hover,
  .edit-comment:hover,
  .delete-comment:hover {
    background: var(--secondary);
  }


  /* Stealth Toggle */
  .stealth-switch {
    position: absolute;
    top: .5rem;
    right: 1rem;
    display: flex;
    align-items: center;
    z-index: 5;
    filter: brightness(150%);
    filter: contrast(150%);
  }

  .stealth-toggle {
    opacity: 0;
    position: absolute;
  }

  .stealth-toggle-label {
    cursor: pointer;
    width: 30px;
    height: 15px;
    background-color: var(--primary-color, #7f5af0);
    border-radius: 30px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 4px;
    position: relative;
  }


  .stealth-toggle-label .sun-icon {
    opacity: 0;
  }

  .stealth-toggle:checked+.stealth-toggle-label .sun-icon {
    opacity: 1;
  }

  .stealth-toggle:checked+.stealth-toggle-label .moon-icon {
    opacity: 0;
  }

  .stealth-toggle-label::before {
    content: "";
    width: 12px;
    height: 12px;
    background: var(--button-text, #fff);
    border-radius: 50%;
    position: absolute;
    top: 2px;
    left: 1px;
    transition: transform 0.3s ease;
  }

  .stealth-toggle:checked+.stealth-toggle-label::before {
    transform: translateX(15px);
  }
  
  /*Shimmer Effect */

  .shimmer-wrapper {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    /* padding: 1rem; */
  }

  .shimmer-card {
    display: flex;
    background: var(--container-bg);
    border-radius: 10px;
    overflow: hidden;
    animation: pulse 1.5s infinite;
  }

  .shimmer-avatar {
    width: 50px;
    height: 50px;
    background: var(--body-bg);
    border-radius: 50%;
    margin: 1rem;
  }



  .shimmer-lines {
    flex: 1;
    padding: 1rem 0;
  }

  .shimmer-line {
    height: 10px;
    background: var(--body-bg);
    margin: 8px 0;
    border-radius: 5px;
  }

  .shimmer-line.short {
    width: 50%;
  }

  .shimmer-line.tiny {
    width: 30%;
  }

  .shimmer-footer {
    display: flex;
    gap: 1rem;
    margin-top: 1rem;
  }

  .shimmer-btn {
    width: 40px;
    height: 20px;
    background: var(--body-bg);
    border-radius: 5px;
  }

  @keyframes pulse {
    0% {
      background-color: var(--container-bg);
    }

    50% {
      background-color: var(--body-bg);
    }

    100% {
      background-color: var(--container-bg);
    }
  }

  .shimmer {
    background: linear-gradient(90deg, var(--container-bg) 25%, var(--body-bg) 50%, var(--container-bg) 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
  }

  @keyframes shimmer {
    0% {
      background-position: -200% 0;
    }

    100% {
      background-position: 200% 0;
    }
  }

  /* shimmer bubbles */
  .shimmer-comments {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .comment-item.shimmer-bubble {
    display: flex;
    align-items: flex-start;
    gap: 10px;
  }

  .shimmer-circle,
  .shimmer-rect {
    background: linear-gradient(90deg,
        var(--shimmer-base) 25%,
        var(--shimmer-highlight) 50%,
        var(--shimmer-base) 75%);
    background-size: 200% 100%;
    animation: shimmer 1.2s infinite;
  }

  .shimmer-circle {
    width: 32px;
    height: 32px;
    border-radius: 50%;
  }

  .shimmer-rect {
    flex: 1;
    height: 40px;
    border-radius: 12px;
  }

  /* smooth fade-in for real comments */
  .fade-in {
    opacity: 0;
    transform: translateY(5px);
    animation: fadeIn 0.4s forwards;
  }

  @keyframes shimmer {
    0% {
      background-position: -200% 0;
    }

    100% {
      background-position: 200% 0;
    }
  }

  @keyframes fadeIn {
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }




  /*Profile Feeds */
  #userPostsContainer {
    padding: 0 .5rem;
  }

    /* .secret .card {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    padding: 2rem !important;
    background: var(--container-bg);
    border-radius: 1.5rem;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    position: relative !important;
  } */

  .card-header {
    display: flex;
    align-items: center;
    gap: 1rem;
  }


  .user-info {
    display: flex;
    align-items: flex-start !important;
    flex-direction: column;
  }

  .user-info .username {
    font-weight: bold;
    font-size: 1rem;
    margin: 0;
  }

  .user-info .timestamp {
    font-size: 0.75rem;
    color: var(--text-color);
  }

  .card-content p {
    font-size: 1.1rem;
    line-height: 1.6;
    margin: 0 !important;
  }


  .reaction-btn {
    display: flex !important;
    flex-direction: row !important;
    align-items: center !important;
    gap: .75rem;
    background: var(--body-bg) !important;
    margin-right: .5rem;
  }

  .reaction-btn .reactions span {
    margin-left: -1rem;
  }



  /* Edit profile Modal */
  #editModal {
    display: none;
    position: fixed;
    top: 5%;
    left: 0%;
    right: 0%;
    z-index: 999;
  }

  .avatar-wrapper {
    position: relative;
    border-radius: 50%;
    overflow: hidden;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
  }

  .avatar-wrapper:hover::after {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    bottom: 0;
    right: 0;
    background: rgba(0, 0, 0, 0.2);
  }


  .avatar-selector-wrapper {
    margin: 2rem auto;
    max-width: 90%;
    text-align: center;
  }

  .carousel-container {
    position: relative;
    overflow: hidden;
  }

  .center-highlight {
  position: absolute;
  top: 0;
  bottom: 0;
  left: 50%;
  width: 100px ;
  height: 100px ;
  transform: translateX(-50%);
  border-radius: 50%;
  z-index: 10;
  pointer-events: none;
  border: 2px solid var(--primary-color);
  box-shadow: 0 0 10px var(--primary-color);
  animation: pulse 2s infinite alternate;
}


@keyframes pulse {
  from { box-shadow: 0 0 10px var(--primary-color); }
  to   { box-shadow: 0 0 25px var(--primary-color), 0 0 40px rgba(127,90,240,.4); }
}

  .avatar-carousel {
    display: flex;
    overflow-x: auto;
    margin: auto;
    gap: 1.5rem;
    scroll-behavior: smooth;
    padding: .75rem 0;
    scroll-snap-type: x mandatory;
    scrollbar-width: none;
  }

  .avatar-carousel::-webkit-scrollbar {
    display: none;
  }

  .avatar-item.spacer {
    height: 95px;
    pointer-events: none;
    opacity: 0;
  }


  .avatar-item {
    flex: 0 0 auto;
    width: clamp(70px, 8vw, 90px);
  height: clamp(70px, 8vw, 90px);
    border-radius: 50%;
    overflow: hidden;
    scroll-snap-align: center;
    position: relative;
    transition: all 0.3s ease;
    transform: scale(0.7);
    opacity: 0.4;
  }

  .avatar-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 50%;
  }

  .avatar-item.active {
    transform: scale(1.1);
    opacity: 1;
    z-index: 5;
    box-shadow: 0 0 15px rgba(127, 90, 240, 0.6); /* glow based on theme color */
  }

  #editProfileForm .form-group {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    width: 100%;
  }

  #editProfileForm label {
    font-size: 1.1rem !important;
  }



  .upload-btn {
    display: inline-block;
    margin-top: 0.5rem;
    background: var(--secondary-color);
    color: var(--button-text);
    padding: 0.4rem 1rem;
    font-size: 0.9rem;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.3s ease;
  }

  .upload-btn:hover {
    background: var(--primary-hover);
  }

  .info-section {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
  }

  .info-section h2 {
    font-size: 1.5rem;
    color: var(--text-color);
    margin-bottom: 0.5rem;
  }

  .bio {
    font-size: 0.95rem;
    color: var(--muted-text);
    text-align: center;
  }

  .profile-form .form-group {
    margin-bottom: 1.2rem;
  }

  .profile-form label {
    display: block;
    margin-bottom: 0.4rem;
    color: var(--text-color);
    font-size: 0.9rem;
  }

  .profile-form input,
  .profile-form textarea {
    width: 100%;
    padding: 0.6rem;
    border: 1px solid var(--text-color);
    border-radius: 0.6rem;
    background: var(--input-bg);
    color: var(--text-color);
    font-size: 0.95rem;
  }

  .profile-form textarea {
    resize: vertical;
    min-height: 100px;
  }

  .save-btn {
    background: var(--primary-color);
    color: var(--button-text);
    padding: 0.6rem 1.2rem;
    border: none;
    border-radius: 0.6rem;
    font-weight: bold;
    cursor: pointer;
    transition: background 0.3s ease;
  }

  .save-btn:hover {
    background: var(--primary-hover);
  }


/* Share Modal */
  .share-modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(5px);
    color: #fff;
    justify-content: center;
    align-items: center;
    z-index: 2 !important;
  }

  .share-modal .modal-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: .5rem;
    margin-top: -1rem;
  }


  .share-link {
    padding: .5rem;
    width: auto;
    font-size: 1rem;
    color: #fff;
    font-weight: 300;
    background: var(--secondary-color);
    border: none;
  }

  .socials {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    margin: .5rem;
  }

  .socials .share-whatsApp {
    color: green;
  }

  .socials .share-messenger {
    color: royalblue;
  }

  .socials .share-snapchat {
    color: yellow;
  }

  .socials .share-twitter {
    color: var(--text-color);
  }

  .close-share-modal,
  .copy-link {
    color: #fff !important;
  }
</style>

<div id="main">
  <section class="main">

    <div class="jumbotron text-center">

      <% if(locals.userProfile){ %>
        <div id="profile">
          <div class="profile-header">
            <div class="banner-image"> 

              <input type="hidden" id="avatarAlt" value="<%= userAvatarAlt %>" />
              <div class="banner-overlay"></div>
              <!-- <img id="bannerImage" src="/img/avatars/banners/<%= userAvatarAlt %>.jpg" alt="<%= userAvatarAlt %>"> -->
            </div>

            <div class="avatar-status-wrap">
              <div class="avatar-profile editable-avatar">
                <img src="<%= userPicture %>" alt="Avatar" class="profile-pic" onclick="editAvatar()">
              </div>
              <div class="username-bundle">
                <p class="username-row">
                  <span id="active-status" class="status">
                    <%= activeStatus ? 'üü¢ ' : 'üî¥' ; %>
                  </span>

                  <small class="username">
                    <span class="user user<%= profileId %>">
                      <% if(stealthMode){ %>
                        @voice<%= profileId %>
                          <% } else { %>
                            @<%= userName %>
                              <% } %>
                    </span>

                    <% if(verified===true) {%>
                      <img src="../../img/gossipa3.png" class="verified-badge" alt="">
                      <% } %>
                  </small>

                </p>

                <p class="user-bio empty">
                  <% if (userBio) { %>
                    <span>--"<%= userBio %>."--</span>
                    <% } else { %>
                      <span>No bio yet.</span>
                      <% } %>
                </p>

                <button class="edit-profile-btn eavedrop-btn btn-gradient" data-targetid="<%= profileId %>">
                  <i class="fas fa-ear-deaf"></i>
                  <span>Resonate</span>
                </button>

              </div>
            </div>

            <div class="quick-stats">
              <% const isMoreThanOne = userProfile.length > 1 %>
              <div class="stat">
                <strong>
                  <%= formatCount(userProfile.length || 0) %>
                </strong>
                <span><%= isMoreThanOne ?  "Echoes" : "Echo" %></span>
              </div>
              <div class="stat">
                <strong>
                  <%= formatCount(audienceCount) %>
                </strong>
                <span>Resonators</span>
              </div>
              <div class="stat">
                <strong>
                  <%= formatCount(totalReactions || 0) %>
                </strong>
                <span>Reactions</span>
              </div>
            </div>

           
          </div>

          <hr style="margin-top: 2rem;">

          <!-- Profile Nav -->
          <form id="navigator">
            <input type="hidden" id="user" name="user" value="<%= profileId %>">
            <button class="current navigation text" data-type="text">Textprint</button>
            <button class="navigation audio" data-type="audio">Audioprint</button>
          </form>


          <div id="shimmer-container" class="shimmer-container">
            <ul>
              <% for (let i=0; i < userProfile.length; i++) { %>
                <li class="secret shimmer-placeholder">
                  <div class="card">
                    <div class="shimmer-wrapper">
                      <div class="shimmer-card">
                        <div class="shimmer-lines">
                          <div class="shimmer-line short"></div>
                          <div class="shimmer-line"></div>
                          <div class="shimmer-line"></div>
                          <div class="shimmer-footer">
                            <div class="shimmer-btn"></div>
                            <div class="shimmer-btn"></div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </li>
                <% } %>
            </ul>
          </div>


          <div id="real-secrets" style="display: none;">
            <ul id="userPostsContainer">
              <% if (locals.userProfile) { %>

                <% userProfile.forEach((secret)=> { %>
                  <% const isLongSecret=secret.secret.split(" ").length > 17;
             %>
          <li class=" secret <%=isLongSecret ? 'full-width' : 'half-width' %>" id="secret<%= secret.id %>"
                      data-type="text">

                      <div class="card">

                        <div class="card-header">
                          <div class="user-info">

                            <span class="timestamp" data-raw="<%= secret.timestamp %>"></span>
                          </div>

                        </div>

                        <div class="card-content">
                          <p>
                            <span class="content">
                              <% if (secret.secret.split(" ").length > 200) { %>
<%= secret.secret.substring(0, 250) + " ..." %>
                                <% } else { %>
                                  <%= secret.secret %>
                                    <% } %>
                            </span>
                            <% if (secret.secret.split(" ").length > 200) { %>

    <button
class=" read" style="
  background: none;
  font-size: 1rem;
  padding: 0;
  font-weight: bold;
  padding: .75rem !important;
  font-weight: bold;
  font-family: 'Courier New', Courier, monospace !important;
" data-full="<%= secret.secret %>" data-truncated="<%= secret.secret.substring(0, 250) + '...' %>">
                              Read More
                              </button>


                              <% } %>
                          </p>
                        </div>



                        <div class="comment-section" data-post-id="<%= secret.id %>" data-type="text">

                          <div class="reactions sleek">
                            <div class="first-action">
                              <div class="secret-card" data-id="<%= secret.id %>">
                                <div class="reaction">
                                  <div class="reaction-btn">
                                    <div class="reactions">
                                      <span>
                                        üëç
                                      </span>
                                      <span>
                                        üòÇ
                                      </span>
                                      <span>
                                        üò¢
                                      </span>
                                      <span>
                                        üò±
                                      </span>
                                    </div>
                                    <div class="reaction-class-wrapper">
                                      <span class="reaction-count">
                                        <%= formatCount(secret.reactions.like ? secret.reactions.like.count : 0 +
                                          secret.reactions.laugh ? secret.reactions.laugh.count : 0 +
                                          secret.reactions.cry ? secret.reactions.cry.count : 0 + secret.reactions.gasp
                                          ? secret.reactions.gasp.count : 0) %>
                                      </span>
                                    </div>
                                  </div>

                                </div>

                              </div>

                              <button id="commentButton"><i class="fas fa-comment"></i><span
                                  class="comment-count"></span>
                              </button>
                            </div>

                            <ul class="second-action">
                              <li class="bookmarked"><i class="fas fa-bookmark"></i>&nbsp;<span id="bookmarkCount">
                                  <%= formatCount(secret.bookmark_count) %>
                                </span>
                              </li>


                            </ul>

                          </div>

                          <div class="comment-dropdown" id="commentDropdown">
                            <form class="comment-display" method="POST" id="commentDisplay">
                              <p class="total">Share your thoughts</p>
                              <ul id="comments" class="comments-list"></ul>
                            </form>

                            <form action="/comment" method="POST" id="comment-form">
                              <input type="hidden" name="id" id="secretId" value="<%= secret.id %>" />
                              <input type="hidden" name="secretUserId" value="<%= secret.user_id %>" />
                              <input type="hidden" name="commentUserId" value="<%= userId %>" />
                              <textarea id="commentInput" placeholder="Write a comment..." name="comment"></textarea>
                              <!-- <input type="text" id="commentInput" placeholder="Write a comment" name="comment"> -->
                              <button id="postCommentButton">
                                <!-- Post -->
                                <i class="fas fa-paper-plane"></i>
                              </button>
                              <% if (locals.message) { %>
                                <small>
                                  <%= message %>
                                </small>
                                <% } %>
                            </form>

                          </div>
                        </div>

                        <ul class="card-menu">
                          <li>
                            <button class="card-toggle-btn"><i class="fas fa-ellipsis-vertical"></i></button>
                            <ul class="card-menu-content" style="display: none;">
                              <li>
                                <button class="report-btn" data-id="<%= secret.id %>">
                                  <i class="fa-regular fa-flag"></i>Report
                                </button>
                              </li>
                            </ul>
                      </div>
                      </li>

                      <% }) %>

                        <center class="bottom-message" id="scrollEndMessage">
                          <p>Reached last Gossips. Scroll back to top </p>
                        </center>

                        <script>
                          document.addEventListener('DOMContentLoaded', () => {
                            const scrollEndMessage = document.getElementById('scrollEndMessage');

                            window.addEventListener('scroll', () => {
                              const scrollPosition = window.scrollY + window.innerHeight;
                              const pageHeight = document.body.offsetHeight;

                              if (scrollPosition >= pageHeight - 50) {
                                // User reached near bottom
                                scrollEndMessage.style.opacity = '1';
                                scrollEndMessage.style.zIndex = '100'
                              } else {
                                scrollEndMessage.style.opacity = '0';
                              }
                            });
                          });
                        </script>




                        <% } else {%>
                          <li class="secret">
                            <div class="card">
                              <div class="card-content">No Posts</div>
                            </div>
                          </li>
                          <% } %>

            </ul>
          </div>
        </div>
        <% } else if(locals.profile){ %>
          <div id="profile">
            <div class="profile-header">
              <div class="banner-image">
                
              <div class="card-footer">
                <button id="editProfileBtn" class="edit-profile-btn"><i class="fas fa-pen"></i>&nbsp;Edit
                  Profile</button>
              </div>

                <span class="stealth-switch">
                  <input type="checkbox" id="stealthToggle" class="stealth-toggle" <% if (stealthMode) { %> checked
                  <% } %>
                    />
                    <label for="stealthToggle" class="stealth-toggle-label">
                    </label>
                </span>

                <input type="hidden" id="avatarAlt" value="<%= avatarAlt %>" />
                <div class="banner-overlay"></div>
                <!-- <img id="bannerImage" src="/img/avatars/banners/<%= avatarAlt %>.jpg" alt="<%= avatarAlt %>"> -->
              </div>
              <div class="avatar-status-wrap">
                <div class="avatar-profile editable-avatar">
                  <img src="<%= profilePicture %>" alt="Avatar" class="profile-pic" onclick="editAvatar()">
                </div>
                <div class="username-bundle">
                  <p class="username-row">
                    <small class="username">
                      <span class="user<%= userId %>">
                        <% if(stealthMode){ %>
                          <span class="user">@voice<%= userId %></span>
                          <% } else { %>
                            <span class="user"> @<%= username %></span>
                            <% } %>
                      </span>

                      <% if(verification===true) {%>
                        <img src="img/gossipa3.png" class="verified-badge" alt="">
                        <% } %>
                    </small>

                  </p>

                  <p class="user-bio empty">
                    <% if (userBio) { %>
                      <span>--"<%= userBio %>."</span>
                      <% } else { %>
                        <span>No bio yet. <a href="#" class="listen" onclick="editBio()">Add something...</a></span>
                        <% } %>
                  </p>
                </div>
              </div>

              <div class="quick-stats">
                <% const isMoreThanOne = profile.length > 1 %>
                <div class="stat">
                  <strong>
                    <%= formatCount(profile.length || 0) %>
                  </strong>
                  <span><%= isMoreThanOne ? "Echoes" : "Echo" %></span>
                </div>
                <div class="stat">
                  <strong>
                    <%= formatCount(audienceCount) %>
                  </strong>
                  <span>Resonators</span>
                </div>
                <div class="stat">
                  <strong>
                    <%= formatCount(totalReactions || 0) %>
                  </strong>
                  <span>Reactions</span>
                </div>
              </div>

            </div>

            <hr style="margin-top: 2rem;">

            <!-- Profile Nav -->
            <form id="navigator">
              <input type="hidden" id="user" name="user" value="<%= userId %>">
              <button class="current navigation text" data-type="text">Textprint</button>
              <button class="navigation audio" data-type="audio">Audioprint</button>
            </form>

            <div id="shimmer-container" class="shimmer-container">
              <ul>
                <% for (let i=0; i < profile.length; i++) { %>
                  <li class="secret shimmer-placeholder">
                    <div class="card">
                      <div class="shimmer-wrapper">
                        <div class="shimmer-card">
                          <div class="shimmer-lines">
                            <div class="shimmer-line short"></div>
                            <div class="shimmer-line"></div>
                            <div class="shimmer-line"></div>
                            <div class="shimmer-footer">
                              <div class="shimmer-btn"></div>
                              <div class="shimmer-btn"></div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </li>
                  <% } %>
              </ul>
            </div>

            <div id="real-secrets" style="display: none;">
              <ul id="userPostsContainer">
                <% if (locals.profile) { %>


                  <% profile.forEach((secret)=> { %>
                    <% const isLongSecret=secret.secret.split(" ").length > 17;
                 %>
              <li class=" secret full-width gist-list" id="secret<%= secret.id %>" data-type="<%= secret.type %>">

                      <div class="card">


                        <template id="shimmerTemplate">
                          <li class="secret shimmer-wrapper">
                            <div class="card shimmer-card">

                              <div class="card-header">
                                <div class="user-info">
                                  <div class="shimmer-avatar"></div>
                                  <div class="shimmer-lines">
                                    <div class="shimmer-line short"></div>
                                    <div class="shimmer-line tiny"></div>
                                  </div>
                                </div>

                                <div class="card-content">
                                  <div class="shimmer-lines">
                                    <div class="shimmer-line short"></div>
                                    <div class="shimmer-line"></div>
                                    <div class="shimmer-line"></div>
                                  </div>
                                </div>

                                <div class="shimmer-footer">
                                  <div class="shimmer-btn"></div>
                                  <div class="shimmer-btn"></div>
                                </div>

                              </div>
                          </li>
                        </template>


                        <div class="card-header">
                          <div class="user-info">
                            <span class="timestamp" data-raw="<%= secret.timestamp %>"></span>
                          </div>

                        </div>

                        <div class="card-content">
                          <p>
                            <span class="content">
                              <% if (secret.secret.split(" ").length > 200) { %>
    <%= secret.secret.substring(0, 250) + " ..." %>
                                <% } else { %>
                                  <%= secret.secret %>
                                    <% } %>
                            </span>
                            <% if (secret.secret.split(" ").length > 200) { %>
    
        <button
    class=" read" style="
      background: none;
      font-size: 1rem;
      padding: 0;
      font-weight: bold;
      padding: .75rem !important;
      font-weight: bold;
      font-family: 'Courier New', Courier, monospace !important;
    " data-full="<%= secret.secret %>" data-truncated="<%= secret.secret.substring(0, 250) + '...' %>">
                              Read More
                              </button>


                              <% } %>
                          </p>
                        </div>

                        <div class="comment-section" data-post-id="<%= secret.id %>" data-type="<%= secret.type %>">

                          <div class="reactions sleek">
                            <div class="first-action">
                              <div class="secret-card" data-id="<%= secret.id %>">
                                <div class="reaction">

                                  <div class="reaction-btn">
                                    <div class="reactions">
                                      <span>
                                        üëç
                                      </span>
                                      <span>
                                        üòÇ
                                      </span>
                                      <span>
                                        üò¢
                                      </span>
                                      <span>
                                        üò±
                                      </span>
                                    </div>
                                    <div class="reaction-class-wrapper">
                                      <span class="reaction-count">
                                        <%= formatCount(secret.reactions.like ? secret.reactions.like.count : 0 +
                                          secret.reactions.laugh ? secret.reactions.laugh.count : 0 +
                                          secret.reactions.cry ? secret.reactions.cry.count : 0 + secret.reactions.gasp
                                          ? secret.reactions.gasp.count : 0) %>
                                      </span>
                                    </div>
                                  </div>

                                </div>

                              </div>

                              <button id="commentButton"><i class="fas fa-comment"></i><span
                                  class="comment-count"></span>
                              </button>
                            </div>

                            <ul class="second-action">
                              <li class="bookmarked"><i class="fas fa-bookmark"></i>&nbsp;<span id="bookmarkCount">
                                  <%= formatCount(secret.bookmark_count) %>
                                </span>
                              </li>


                            </ul>

                          </div>

                          <div class="comment-dropdown" id="commentDropdown">
                            <form class="comment-display" method="POST" id="commentDisplay">
                              <p class="total">Share your thoughts</p>
                              <ul id="comments" class="comments-list"></ul>
                            </form>

                            <form action="/comment" method="POST" id="comment-form">
                              <input type="hidden" name="id" id="secretId" value="<%= secret.id %>" />
                              <input type="hidden" name="secretUserId" value="<%= secret.user_id %>" />
                              <input type="hidden" name="commentUserId" value="<%= userId %>" />
                              <textarea id="commentInput" placeholder="Write a comment..." name="comment"></textarea>
                              <!-- <input type="text" id="commentInput" placeholder="Write a comment" name="comment"> -->
                              <button id="postCommentButton">
                                <!-- Post -->
                                <i class="fas fa-paper-plane"></i>
                              </button>
                              <% if (locals.message) { %>
                                <small>
                                  <%= message %>
                                </small>
                                <% } %>
                            </form>

                          </div>
                        </div>

                        <div class="card-menu">
                          <button class="card-toggle-btn"><i class="fas fa-ellipsis-vertical"></i></button>

                          <form method="post" id="update" class="card-menu-content" style="display: none;">
                            <input type="hidden" name="secId" id="secId" value="<%= secret.id %>" />

                            <button class="edit" type="submit" formaction="/edit">
                              <abbr title="edit">
                                Edit&nbsp;<i class="fas fa-file-pen"></i>
                              </abbr>
                            </button>


                            <button class="delete" type="click">
                              <abbr title="delete">
                                Delete&nbsp;<i class="fas fa-trash"></i>
                              </abbr>
                            </button>

                          </form>
                        </div>
                      </div>
                      </li>

                      <% }) %>



                        <script>

                          // Handle theme toggle
                          document.getElementById('stealthToggle').addEventListener('change', async (e) => {

                            const isChecked = e.target.checked;

                            try {
                              const res = await fetch("/stealth", {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({ stealth: isChecked })
                              });

                              const data = await res.json();


                              const userId = '<%= userId %>'
                              const usernameEl = document.querySelectorAll(`.user${userId}`);
                              const user = '<%= username %>'


                              if (data.status === "enabled") {
                                usernameEl.forEach((username) => {
                                  const usernameSpan = username.querySelector('.user')
                                  usernameSpan.textContent = "@voice" + userId; // or however you store it
                                })
                              } else {
                                usernameEl.forEach((username) => {
                                  const usernameSpan = username.querySelector('.user')
                                  usernameSpan.textContent = "@" + user;
                                })
                              }

                            } catch (err) {
                              console.log(err);
                            }
                          });


                        </script>

                        <center class="bottom-message" id="scrollEndMessage">
                          <p>Reached last Echo. Scroll back to top </p>
                        </center>

                        <script>
                          document.addEventListener('DOMContentLoaded', () => {
                            const scrollEndMessage = document.getElementById('scrollEndMessage');

                            window.addEventListener('scroll', () => {
                              const scrollPosition = window.scrollY + window.innerHeight;
                              const pageHeight = document.body.offsetHeight;

                              if (scrollPosition >= pageHeight - 50) {
                                // User reached near bottom
                                scrollEndMessage.style.opacity = '1';
                                scrollEndMessage.style.zIndex = '100'
                              } else {
                                scrollEndMessage.style.opacity = '0';
                              }
                            });
                          });
                        </script>



                        <% } else {%>

                          <% } %>

              </ul>
            </div>
          </div>



          <section id="editModal" class="profile-page">
            <div id="tutorial-overlay">
              <div class="profile-card">
                <span class="edit-close-btn">&times;</span>

                <div class="info-section">
                  <div class="avatar-wrapper avatar-profile">
                    <img src="../.<%= profilePicture %>" alt="User Avatar" class="profile-pic" id="profilePicPreview" />

                    <input type="hidden" id="selectedAvatarInput" name="selectedAvatarInput"
                      value="../.<%= profilePicture %>" />
                    <input type="hidden" id="selectedAvatarAlt" name="selectedAvatarAlt"
                      value='../.<%= profilePicture %>' />

                  </div>
                  <small id="displayUser">@<%= username %></small>
                  <% if (userBio){ %>
                    <p class="bio">--"<%= userBio %>."</p>
                    <% }else{ %>
                      <span>No bio yet. <a href="#" class="listen" onclick="editBio()">Add something...</a></span>
                      <% } %>
                </div>

                <div class="form-group">
                <div class="avatar-selector-wrapper">
                  <h3 class="display-3">Change Your Avatar</h3>
                  <div class="carousel-container">
                    <div class="center-highlight"></div>
                    <div class="avatar-carousel" id="avatarCarousel">
                      <div class="avatar-item spacer"></div> <!-- before -->

                      <div class="avatar-item"><img src="./img/avatars/thumbs/whisper.jpg" alt="whisper" /></div>
                      <div class="avatar-item"><img src="./img/avatars/thumbs/pulse.jpg" alt="pulse" /></div>
                      <div class="avatar-item"><img src="./img/avatars/thumbs/reverb.jpg" alt="reverb" /></div>
                      <div class="avatar-item"><img src="./img/avatars/thumbs/sonic.jpg" alt="sonic" /></div>
                      <div class="avatar-item"><img src="./img/avatars/thumbs/phantom.jpg" alt="phantom" /></div>
                      <div class="avatar-item"><img src="./img/avatars/thumbs/chorus.jpg" alt="chorus" /></div>
                      <div class="avatar-item"><img src="./img/avatars/thumbs/vibe.jpg" alt="vibe" /></div>
                      <div class="avatar-item"><img src="./img/avatars/thumbs/Resonance.jpg" alt="Resonance" /></div>
                      <!-- Add more avatars -->

                      <div class="avatar-item spacer"></div> <!-- after -->
                    </div>
                  </div>

                </div>
              </div>
                <form id="editProfileForm" class="profile-form">

                  <div class="form-group">
                    <label for="displayName">Username</label>
                    <input type="text" name="username" id="displayName" value="<%= username %>" />
                  </div>
                  <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" name="email" id="email" value="<%= email %>" />
                  </div>
                  <div class="form-group">
                    <label for="bio">Bio</label>
                    <textarea id="bio" name="bio"><%= userBio %></textarea>
                  </div>

                  <button type="submit" id="saveBtn" class="save-btn">Save Changes</button>
                </form>
              </div>
            </div>
          </section>


          <script>
            const carousel = document.getElementById('avatarCarousel');
            const avatarItems = document.querySelectorAll('.avatar-item');
            const centerHighlight = document.querySelector('.center-highlight');
            const profilePicPreview = document.getElementById("profilePicPreview")
            const selectedAvatar = document.getElementById("selectedAvatar")
            const selectedAvatarInput = document.getElementById("selectedAvatarInput")
            const selectedAvatarAlt = document.getElementById("selectedAvatarAlt")


            function resizeHighlightToActive() {
          const active = document.querySelector('.avatar-item.active');
          if (active && centerHighlight) {
            const rect = active.getBoundingClientRect();
            const size = rect.width + 10; // halo margin
            centerHighlight.style.width = size + "px";
            centerHighlight.style.height = size + "px";
          }
        }

        function updateSpacers() {
  const carousel = document.getElementById('avatarCarousel');
  const spacers = document.querySelectorAll('.avatar-item.spacer');
  const avatar = document.querySelector('.avatar-item:not(.spacer)');

  if (!carousel || !avatar) return;

  const carouselRect = carousel.getBoundingClientRect();
  const avatarRect = avatar.getBoundingClientRect();

  // Center point of the carousel
  const centerOffset = carouselRect.width / 2;

  // Spacer should equal center position minus half avatar width
  const spacerWidth = centerOffset - (avatarRect.width / 2);

  spacers.forEach(spacer => {
    spacer.style.width = spacerWidth + "px";
  });
}

            function updateCenterSelection() {
              let closest = null;
              let closestDistance = Infinity;

              document.querySelectorAll('.avatar-item:not(.spacer)').forEach(item => {
                const rect = item.getBoundingClientRect();
                const centerX = window.innerWidth / 2;
                const itemCenter = rect.left + rect.width / 2;
                const distance = Math.abs(centerX - itemCenter);

                if (distance < closestDistance) {
                  closestDistance = distance;
                  closest = item;
                }
              });

              document.querySelectorAll('.avatar-item').forEach(item =>
                item.classList.remove('active')
              );
              if (closest) {
                closest.classList.add('active');
                const img = closest.querySelector('img');
                if (img) {
                  const relativePath = img.getAttribute("src").replace(/^.*\/img/, "/img");
                  profilePicPreview.src = img.src;
                  selectedAvatarInput.value = relativePath;
                  selectedAvatarAlt.value = img.alt.toLowerCase();
                }
                resizeHighlightToActive();
              }
            }


            function scrollToCenter(element) {
              const carouselRect = carousel.getBoundingClientRect();
              const elementRect = element.getBoundingClientRect();
              const offset = (elementRect.left + elementRect.width / 2) - (carouselRect.left + carouselRect.width / 2);
              carousel.scrollBy({ left: offset, behavior: 'smooth' });
            }

            avatarItems.forEach(item => {
              item.addEventListener('click', () => {
                scrollToCenter(item);
                const img = item.querySelector('img');
                if (img) {
                  const relativePath = img.getAttribute("src").replace(/^.*\/img/, "/img");
                  profilePicPreview.src = img.src;
                  selectedAvatarInput.value = relativePath;
                  selectedAvatarAlt.value = img.alt.toLowerCase();
                }
              });
            });


            carousel.addEventListener('scroll', () => {
              window.requestAnimationFrame(updateCenterSelection);
            });

            document.addEventListener('keydown', (e) => {
          const active = document.querySelector('.avatar-item.active');
          if (!active) return;
          if (e.key === "ArrowRight" && active.nextElementSibling) {
            scrollToCenter(active.nextElementSibling);
          } else if (e.key === "ArrowLeft" && active.previousElementSibling) {
            scrollToCenter(active.previousElementSibling);
          }
        });
      
// Run again on resize (responsive fix)
window.addEventListener('resize', () => {
  updateSpacers();
  updateCenterSelection(); // make sure highlight stays locked
});

      
        // Initial center on page load (middle avatar)
        setTimeout(() => {
          const middleIndex = Math.floor(avatarItems.length / 2);
          const middleAvatar = avatarItems[middleIndex];
          if (middleAvatar) {
            scrollToCenter(middleAvatar);
            updateCenterSelection();
            // Run once on load
updateSpacers();
          }
        }, 200);
          </script>

          <script>
            const usernameInput = document.getElementById("displayName");
            const bioInput = document.getElementById("bio");

            const usernameDisplay = document.querySelector("#displayUser");
            const bioDisplay = document.querySelector(".bio") || document.querySelector("span");


            const availabilityMsg = document.createElement("span");
            availabilityMsg.className = "username-status";
            usernameInput.parentNode.appendChild(availabilityMsg);

            // Live update username
            usernameInput.addEventListener("input", () => {
              clearTimeout(debounceTimer);

              const user = usernameInput.value.trim();
              usernameDisplay.textContent = user ? "@" + user : "@ <%= username %>";


              animateUpdate(usernameDisplay);

              if (user.length < 3) {
                availabilityMsg.textContent = "‚ö†Ô∏è Must be at least 3 chars";
                availabilityMsg.style.color = "orange";
                return;
              }

              // Debounce: only fire after 800ms of inactivity
              debounceTimer = setTimeout(async () => {
                try {
                  const res = await fetch(`/check-username?username=${encodeURIComponent(user)}`);
                  const data = await res.json();

                  if (data.available) {
                    availabilityMsg.textContent = "‚úÖ Username available";
                    availabilityMsg.style.color = "green";
                  } else {
                    availabilityMsg.textContent = "‚ùå " + data.message;
                    availabilityMsg.style.color = "red";
                  }
                } catch (err) {
                  availabilityMsg.textContent = "‚ö†Ô∏è Error checking availability";
                  availabilityMsg.style.color = "orange";
                }
              }, 800);

            });

            // Live update bio
            bioInput.addEventListener("input", () => {
              const val = bioInput.value.trim();

              if (val) {
                bioDisplay.innerHTML = `--"${val}."`;
                bioDisplay.classList.add("bio");
              } else {
                bioDisplay.innerHTML = `No bio yet. <a href="#" class="listen" onclick="editBio()">Add something...</a>`;
              }

              animateUpdate(bioDisplay);
            });

            // Simple animation helper
            function animateUpdate(el) {
              el.style.transition = "opacity 0.2s ease";
              el.style.opacity = "0.5";
              setTimeout(() => {
                el.style.opacity = "1";
              }, 150);
            }
          </script>

          <script>
            const form = document.getElementById("editProfileForm");

            form.addEventListener("submit", async (e) => {
              e.preventDefault();

              const rawAvatar = document.querySelector("input[name='selectedAvatarInput']").value;
              const avatarAlt = document.querySelector("input[name='selectedAvatarAlt']").value;
              const avatarPath = rawAvatar.replace(/^https?:\/\/[^/]+/, "");

              const formData = {
                avatar: avatarPath, // send only relative path
                avatarAlt,
                username: document.getElementById("displayName").value.trim(),
                email: document.getElementById("email").value.trim(),
                bio: document.getElementById("bio").value.trim(),
              };

              try {
                const res = await fetch("/update-profile", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify(formData),
                });

                const data = await res.json();
                const userId = data.user.userId

                if (data.success) {

                  const avatarImg = document.querySelectorAll(".profile-pic");
                  if (avatarImg.length && data.user.avatar) {
                    avatarImg.forEach(img => {
                      img.src = data.user.avatar.startsWith("http")
                        ? data.user.avatar
                        : window.location.origin + data.user.avatar;
                      if (data.user.avatarAlt) {
                        img.alt = data.user.avatarAlt.toLowerCase();
                        // updateBanner(img.alt.toLowerCase());
                      }

                    })
                  }

                  // ‚úÖ Update username (inside the .user span, not generic <small>)
                  const usernameSpan = document.querySelectorAll(`.user${userId} .user`);
                  if (usernameSpan) {
                    usernameSpan.forEach(user => {
                      user.textContent = "@" + data.user.username;
                    })
                  }

                  // ‚úÖ Update bio (inside .user-bio span)
                  const bioContainer = document.querySelector(".user-bio span");
                  if (bioContainer) {
                    if (data.user.bio && data.user.bio.trim() !== "") {
                      bioContainer.textContent = `--"${data.user.bio}."`;

                    } else {
                      bioContainer.innerHTML =
                        `No bio yet. <a href="#" class="listen" onclick="editBio()">Add something...</a>`;
                    }

                    // subtle fade for realism
                    bioContainer.style.opacity = 0;
                    setTimeout(() => (bioContainer.style.opacity = 1), 100);
                  }

                  showToast(data.message)
                  closeModal();
                } else {
                  showToast(data.message)
                }
              } catch (err) {
                console.error("Update error:", err);
                showToast(err)
              }
            });

          </script>

          <script>
            const editBtn = document.getElementById("editProfileBtn");
            const editModal = document.getElementById("editModal");
            const closeBtn = document.querySelector(".edit-close-btn");

            // Show modal
            editBtn.addEventListener("click", () => {
              editModal.style.display = "flex"; // Use flex to center content

              // Give browser a moment to render modal, then initialize carousel
              setTimeout(() => {
  const middleIndex = Math.floor(avatarItems.length / 2);
  const middleAvatar = avatarItems[middleIndex];
  if (middleAvatar) {
    scrollToCenter(middleAvatar);
    updateCenterSelection();
  }
  updateSpacers();
}, 200);

            });

            // Close modal on close button
            closeBtn.addEventListener("click", () => {
              editModal.style.display = "none";
            });

            // Close modal if clicking outside content
            window.addEventListener("click", (e) => {
              if (e.target === editModal) {
                editModal.style.display = "none";
              }
            });

          </script>

          <script>
            function closeModal() {
              document.getElementById("editModal").style.display = "none";
            }
          </script>


          <% } %>

    </div>
  </section>


  <aside class="right-sidebar">
    <div id="aside">

      <div class="premium-aside">
        <div class="premium-card">
          <div class="crown-icon sparkle">üëë</div>

          <h3 class="premium-title">Become a Top Voice</h3>
          <p class="premium-text">Stand out in the World of anonymity. Get Heard. Remain Unknown.</p>

          <div class="trending-stats">
            <span>üî• Trending Now: <strong>152</strong>Top Voices</span>
          </div>

          <div class="avatar-hint">
            <img src="/img/avatars/thumbs/dog.jpg" alt="Anonymous" class="blur-avatar" />
            <p>You‚Äôre 1 step from <strong>trending</strong>‚Ä¶</p>
          </div>

          <a href="/subscribe" class="premium-btn">Unlock Exclusive</a>
        </div>
      </div>

      <div class="aside">
        <center>
          <h4 class="user-count"><button class="dot active animate-ping-once" data-slide="0"></button>&nbsp;Meet Top
            Voices
            :<span id="activeCount">0</span></h4>
        </center>
        <ul class="nav user-list">
        </ul>
      </div>


      <div class="inpage-footer">
        <span>Privacy Policy</span>&nbsp;.
        &nbsp;<span>Terms of use</span> &nbsp;.
        &nbsp;<span>Community guidelines</span> &nbsp;.
        <br><br>
        &nbsp;<span>&copy; <%= new Date().getFullYear() %>, &commat;<span class="text-gradient">Echoes</span> Co. All
            rights reserved</span>
        <span class="motto">Motto: <span class="motto-content">"Your privacy is our priority."</span></span>
      </div>
    </div>
  </aside>

</div>

<!-- Load Day.js and the plugin via CDN -->
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>

<script src="https://unpkg.com/wavesurfer.js"></script>
<script>
  document.addEventListener("beforeunload", () => {
    const user = document.querySelector("input[name='user']").value;
    fetch(`/api/active-status/${user}`)
      .then(res => res.json())
      .then(data => {
        const statusEl = document.getElementById("active-status");
        if (statusEl) {
          statusEl.textContent = data.active ? 'üü¢ ' : 'üî¥';
        }
      })
      .catch(err => console.error('Error fetching active status', err));
  });

  // Fetch active status on initial page load
  document.addEventListener("DOMContentLoaded", () => {
    const user = document.querySelector("input[name='user']").value;
    fetch(`/api/active-status/${user}`)
      .then(res => res.json())
      .then(data => {
        const statusEl = document.getElementById("active-status");
        if (statusEl) {
          statusEl.textContent = data.active ? 'üü¢' : 'üî¥';
        }
      })
      .catch(err => console.error('Error fetching active status', err));
  });

</script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const connectedUsersMap = new Map();
    const userList = document.querySelector(".user-list");
    const userCountDisplay = document.getElementById("activeCount");

    function updateUserCount() {
      if (userCountDisplay) userCountDisplay.textContent = formatCount(connectedUsersMap.size);
    }

    function userConnected(user) {
      if (connectedUsersMap.has(user.id)) return;

      const userBox = document.createElement("li");
      userBox.className = "connected-user nav-item enter";
      userBox.id = `user-${user.id}`;

      const verifiedBadge = user.verified
        ? `<img oncontextmenu="return false;" src="/img/gossipa3.png" alt="Verified Badge" class="verified-badge">`
        : "";

      const stealthMode = user.stealth_mode ? `<span class="user">@voice${user.id}</span>` : `<span class="user">@${user.username}</span>`

      userBox.innerHTML = `
            <div class="user-card" style="display: flex; align-items: center; gap: 10px;">
              <img oncontextmenu="return false;" src="${user.profile_picture}" alt="Avatar" class="profile-pic" style="width: 32px; height: 32px; border-radius: 50%;">
              <p class="username-row">
                 <span class="user${user.id}">${stealthMode}</span>
                ${verifiedBadge}
              </p>
            </div>
          `;

      userList?.appendChild(userBox);
      connectedUsersMap.set(user.id, userBox);
      updateUserCount();

      requestAnimationFrame(() => userBox.classList.add("enter"));
    }

    function userDisconnected(userId) {
      const userBox = connectedUsersMap.get(userId);
      if (userBox) {
        userBox.classList.add("exit");
        userBox.classList.remove("enter");
        setTimeout(() => {
          userBox.remove();
          connectedUsersMap.delete(userId);
          updateUserCount();
        }, 400);
      }
    }

    if (window.socket) {
      window.socket.on("userJoined", async (userId) => {
        try {
          const res = await fetch(`/user/${userId}`);
          const user = await res.json();
          userConnected(user);
        } catch (err) {
          console.error("Failed to fetch user data:", err);
        }
      });

      window.socket.on("userLeft", (userId) => {
        userDisconnected(userId);
      });
    } else {
      console.warn("Socket.io not initialized on this page.");
    }

    // Load currently active users
    fetch("/active-users")
      .then(res => res.json())
      .then(users => users.forEach(userConnected))
      .catch(console.error);
  });
</script>

<script>
  async function initEavedropStatus() {
    try {
      const eavedroppingIds = await fetch("/my-eavedrops").then(res => res.json());
      eavedroppingIds.forEach(id => {
        const eavedropBtn = document.querySelectorAll(`.eavedrop-btn[data-targetid="${id}"]`);
        eavedropBtn.forEach(btn => {
          btn.classList.add("listening");
          btn.querySelector("span").textContent = "Resonating";
          btn.querySelector("i").className = "fas fa-ear-listen";
        });
      });
    } catch (err) {
      console.error("Error loading eavedrop state", err);
    }
  }

  document.addEventListener("DOMContentLoaded", initEavedropStatus);

</script>

<script>
  document.addEventListener("click", async (e) => {
    const eavedropBtn = e.target.closest(".eavedrop-btn");
    if (!eavedropBtn) return;

    const span = eavedropBtn.querySelector("span");
    const icon = eavedropBtn.querySelector("i");
    const targetId = eavedropBtn.dataset.targetid;

    eavedropBtn.disabled = true;
    eavedropBtn.querySelector("i").innerHTML = `<div class="button-spinner"></div>`;
    eavedropBtn.querySelector("i").className = ''

    try {
      const res = await fetch("/eavedrop", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ targetId }),
      });


      const data = await res.json();

      const eavedropBtn = document.querySelector(`.eavedrop-btn[data-targetid="${targetId}"]`);
      const sp = eavedropBtn.querySelector("span");
      const ic = eavedropBtn.querySelector("i");

      eavedropBtn.disabled = false;
      eavedropBtn.querySelector("i").innerHTML = ``;


      if (data.status === "added") {
        eavedropBtn.classList.add("listening");
        sp.textContent = "Resonating";
        ic.className = "fas fa-ear-listen";
      } else if (data.status === "removed") {
        eavedropBtn.classList.remove("listening");
        sp.textContent = "Resonate";
        ic.className = "fas fa-ear-deaf";
      }
    } catch (err) {
      console.error("Eavedrop failed", err);
    }
  });
</script>



</script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const navigatorForm = document.getElementById("navigator");
    const postsContainer = document.getElementById("userPostsContainer");
    const text = document.querySelector(".text")
    const audio = document.querySelector(".audio")
    const shimmerTemplate = document.getElementById("shimmerTemplate");
    const userId = navigatorForm.querySelector("#user").value;

    navigatorForm.addEventListener("click", async (e) => {
      if (e.target.tagName === "BUTTON") {
        e.preventDefault();
        const type = e.target.dataset.type;

        postsContainer.classList.add("fade-out");


        try {
          const res = await fetch(`/fetch-posts/${userId}?type=${type}`);
          const data = await res.json();

          setTimeout(() => {
            postsContainer.innerHTML = "";
            for (let i = 0; i < data.posts.length; i++) {
              const shimmer = shimmerTemplate.content.cloneNode(true);
              postsContainer.appendChild(shimmer);
            }
            postsContainer.classList.remove("fade-out");
            postsContainer.classList.add("fade-in");
          }, 500);


          setTimeout(() => {
            postsContainer.innerHTML = "";

            if (res.ok && data.posts) {
              renderPosts(data.posts, type);

              if (type === "audio") {
                text.classList.remove("current")
                audio.classList.add("current")
                data.posts.forEach(post => {
                  const waveformElement = document.querySelector(`#waveform-${post.id}`);
                  const canvas = document.getElementById(`visualizer-${post.id}`);
                  const audioUrl = post.url;

                  if (waveformElement && canvas && audioUrl) {
                    const wave = WaveSurfer.create({
                      container: waveformElement,
                      waveColor: "#ddd",
                      progressColor: "#555",
                      height: 40,
                      responsive: true,
                      barWidth: 2,
                      barGap: 2
                    });

                    wave.load(audioUrl);

                    const playBtn = document.querySelector(`.wave-play-btn[data-id='${post.id}']`);
                    if (playBtn) {
                      playBtn.addEventListener("click", () => wave.playPause());
                      wave.on("play", () => playBtn.innerText = "‚è∏Ô∏è");
                      wave.on("pause", () => playBtn.innerText = "‚ñ∂Ô∏è");
                      wave.on("finish", () => playBtn.innerText = "‚ñ∂Ô∏è");
                    }

                    wave.on("ready", () => {
                      const audio = wave.media;
                      setupVisualizer(audio, canvas, wave);
                    });
                  } else {
                    console.warn("Waveform element, canvas, or audio URL missing for post:", post.id);
                  }
                });
              }
            } else {
              renderPosts(0, type);
              postsContainer.innerHTML = `<li>No ${type} posts found.</li>`;
            }
          }, 1000);
        } catch (err) {
          console.error("Fetch error:", err);
          postsContainer.innerHTML = `<li>Error loading ${type} posts.</li>`;
        }
      }

      text.classList.add("current")
      audio.classList.remove("current")
    });

    function renderPosts(posts, type) {

      if (posts.length === 0) {
        postsContainer.innerHTML = `<li class="secret fade-in full-width gist-list">
                <p class="content-preview">Echo out something to fill the void</p> 
               </li>
        `;
      } else {

        postsContainer.innerHTML = posts.map(post => {
          const id = post.id;
          const user_id = post.user_id;
          const userId = post.userId
          const timestamp = dayjs(post.timestamp).fromNow() || new Date().toLocaleString();
          const category = post.category || "random";
          const likeCount = post.reactions?.like?.count || 0;
          const hotCount = post.reactions?.hot?.count || 0;
          const laughCount = post.reactions?.laugh?.count || 0;
          const cryCount = post.reactions?.cry?.count || 0;
          const gaspCount = post.reactions?.gasp?.count || 0;
          const totalReactionsCount = formatCount(likeCount + hotCount + laughCount + cryCount + gaspCount);
          const commentCount = formatCount(post.comments?.length || 0);
          const bookmarkCount = formatCount(post.bookmark_count);
          const isAudio = type === "audio";
          const postType = isAudio ? 'audio' : 'text';

          const cardMenu = isAudio
            ? `<form method="post" id="update" class="card-menu-content" style="display: none;" >
                                    <input type="hidden" name="id" id="audioId" value="${post.id}" />
      
                                    <button class="delete" type="click">
                                      <abbr title="Delete your post">
                                        Delete&nbsp;<i class="fas fa-trash"></i>
                                      </abbr>
                                    </button>
      
                                  </form>`
            : `<form method="post" id="update" class="card-menu-content" style="display: none;" >
                                    <input type="hidden" name="id" id="secId" value="${post.id}" />

                                    <button class="edit" type="submit" formaction="/edit">
                                      <abbr title="Edit your post">
                                        Edit&nbsp;<i class="fas fa-file-pen"></i>
                                      </abbr>
                                    </button>
      
                                    <button class="delete" type="click">
                                      <abbr title="Delete your post">
                                        Delete&nbsp;<i class="fas fa-trash"></i>
                                      </abbr>
                                    </button>
      
                                  </form>`;


          const categoryText = isAudio
            ? "üéß"
            : {
              funny: "<i class='fas fa-laugh'></i>",
              love: "<i class='fas fa-heart'></i>",
              nasty: "<i class='fas fa-skull-crossbones'></i>",
              sassy: "<i class='fas fa-face-meh'></i>",
              hilarious: "<i class='fas fa-teeth-open'></i>",
              random: "<i class='fas fa-shuffle'></i>"
            }[category] || "<i class='fas fa-shuffle'></i>";

          const cardContent = isAudio
            ? `
                <div class="audio-visualizer-card">
                  <div class="audio-wave-wrapper">
                    <div class="waveform visually-hidden" id="waveform-${id}"></div>
                    <button class="wave-play-btn" data-id="${id}">‚ñ∂Ô∏è</button>
                    <canvas id="visualizer-${id}" class="audio-canvas"></canvas>
                  </div>
                  
                </div>
              `
            : `<p class="content-preview">${truncateText(post.secret, 250)}</p>`;

          return `
              <li class="secret fade-in full-width gist-list" id="secret${id}" data-type="${postType}">
                <div class="card">
                  
                  <div class="card-header">
                    <div class="user-info">
                      <span class="timestamp" data-raw='${timestamp}'>${timestamp}</span>
                    </div>
                  </div>
                  <div class="card-content">${cardContent}</div>
 <div class="comment-section" data-post-id="${id}" data-type="${postType}">
                  <div class="reactions sleek">
                    <div class="first-action">
                    <div class="secret-card" data-id=${id}>
                       <div class="reaction">
                            
                    <div class="reaction-btn">
                      <div class="reactions">
                        <span>
                                      üëç
                                    </span>
                                    <span>
                                      üòÇ
                                    </span>
                                    <span>
                                      üò¢
                                    </span>
                                    <span>
                                      üò±
                                    </span>
                        </div>
                         <div class="reaction-class-wrapper">
                                      <span class="reaction-count">
                                        ${totalReactionsCount}
                                      </span>
                                    </div>
                      </div>
                  </div>
                      </div>
                      <button id="commentButton"><i class="fas fa-comment"></i><span
                                  class="comment-count"></span>
                      </button>
                    </div>
                    <ul class="second-action">
                              <li class="bookmarked"><i class="fas fa-bookmark"></i>&nbsp;<span id="bookmarkCount">${bookmarkCount}</span></li>
                            </ul>
                            </div>
                   

              <div class="comment-dropdown" id="commentDropdown">
                            <form class="comment-display" method="POST" id="commentDisplay">
                              <p class="total">Share your thoughts</p>
                              <ul id="comments" class="comments-list"></ul>
                            </form>

                            <form action="/comment" method="POST" id="comment-form">
                              <input type="hidden" name="id" id="audioId" value="${id}" />
                              <input type="hidden" name="secretUserId" value="${user_id}" />
                              <input type="hidden" name="commentUserId" value="${userId}" />
                              <textarea id="commentInput" placeholder="Write a comment..." name="comment"></textarea>
                              <!-- <input type="text" id="commentInput" placeholder="Write a comment" name="comment"> -->
                              <button id="postCommentButton">
                                <!-- Post -->
                                <i class="fas fa-paper-plane"></i>
                              </button>
                            </form>

                          </div>
                        </div>

                        <div class="card-menu">
              <button class="card-toggle-btn"><i class="fas fa-ellipsis-vertical"></i></button>
              ${cardMenu}
          </div>
                      </div>
                      </li>

            `;
        }).join("");

        fetchComment(); // every 10s
      }
    }

    function truncateText(text, maxLength) {
      return !text || text.length <= maxLength ? text : text.substring(0, maxLength) + '...';
    }

    function setupVisualizer(audioElement, canvas, waveInstance) {
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const analyser = audioCtx.createAnalyser();
      const source = audioCtx.createMediaElementSource(audioElement);
      const ctx = canvas.getContext("2d");

      source.connect(analyser);
      analyser.connect(audioCtx.destination);
      analyser.fftSize = 256;

      const bufferLength = analyser.frequencyBinCount;
      const dataArray = new Uint8Array(bufferLength);
      canvas.width = canvas.offsetWidth;
      canvas.height = canvas.offsetHeight;

      const width = canvas.width;
      const height = canvas.height;
      const barWidth = width / bufferLength;

      function draw() {
        requestAnimationFrame(draw);
        analyser.getByteFrequencyData(dataArray);
        ctx.clearRect(0, 0, width, height);
        dataArray.forEach((value, i) => {
          const barHeight = (value / 255) * height;
          const hue = (i / bufferLength) * 360;
          ctx.fillStyle = `hsl(${hue}, 70%, 50%)`;
          ctx.fillRect(i * barWidth, height - barHeight, barWidth - 1, barHeight);
        });
      }

      const startDrawing = () => {
        audioCtx.resume();
        draw();
      };

      // Sync drawing to play events
      if (waveInstance) {
        waveInstance.on("play", startDrawing);
      } else {
        audioElement.onplay = startDrawing;
      }
    }
  });
</script>

<script>
  function fetchComment() {
    fetch("/api/comment-counts")
      .then(res => res.json())
      .then(counts => {
        document.querySelectorAll(".comment-section").forEach(section => {
          const id = section.dataset.postId;
          const type = section.dataset.type;
          const key = `${type}-${id}`;
          const countEl = section.querySelector(".comment-count");
          const count = counts[key];
          if (countEl && countEl.textContent !== String(count ?? 0)) {
            countEl.textContent = formatCount(count ?? 0);
          }
        });
      })
      .catch(err => console.error("Failed to fetch comment counts", err));
  }
</script>

<script>
  window.currentUserId = "<%= userId %>";
  window.socket = io({ query: { userId: window.currentUserId } });

  socket.on("comment-updated", (data) => {
    const { postId, type, totalComments } = data;
    const section = document.querySelector(`.comment-section[data-post-id="${postId}"][data-type="${type}"]`);

    if (section) {
      const countEl = section.querySelector(".comment-count");
      const commentTotal = section.querySelector(".total-count")
      if (countEl && countEl.textContent !== String(totalComments)) {
        countEl.textContent = formatCount(totalComments);
        if (section.querySelector(".comment-dropdown").classList.contains("active")) {
          commentTotal.textContent = totalComments;
        }
      }
    }
  });

  socket.on("new-comment", (comment) => {
    const { postId, type, username, stealthMode, profilePicture, user_id, comment: text, id } = comment;
    const section = document.querySelector(`.comment-section[data-post-id="${postId}"][data-type="${type}"]`);
    const display = section?.querySelector(".comment-display");
    const commentList = display.querySelector(".comments-list");


    if (display && section.querySelector(".comment-dropdown").classList.contains("active")) {

      const li = document.createElement("li");
      li.classList.add("comment-item");
      li.innerHTML = `
        <img src="${comment.profilePicture}" class="profile-pic thumb"/>
        <div>
          <small class="user">
            ${comment.stealth_mode ? '@voice' + comment.user_id : comment.username}
            </small>
          <p class="comment">${text}</p>
        <button type="button" class="translate-btn" data-id="${id}" data-text="${text}">Translate to english</button>
        <p class="translated-text" id="translated-${postId}-${id}"></p>
        </div>
    `;

      commentList.prepend(li); // ‚úÖ prepend to top
    }
  });
</script>


<script>
  document.querySelector("#userPostsContainer").addEventListener("click", async (e) => {

    if (e.target.closest(".reaction-btn")) {
      const button = e.target.closest(".reaction-btn")

      const animations = {
        like: '.././img/lottie/like.json',
        laugh: '.././img/lottie/laugh.json',
        cry: '.././img/lottie/cry.json',
        gasp: '././img/lottie/gasp.json',
        hot: '.././img/lottie/hot.json'
      };


      const btn = event.target.closest(".reaction-btn");
      const type = btn.getAttribute("data-type");
      const secretCard = btn.closest(".secret-card");
      const secretId = secretCard.getAttribute("data-id");

      const emojiChar = btn.querySelector(".reaction-icon")?.alt || btn.textContent.trim().split('\n')[0];

      const card = btn.closest('.secret');
      const isAudio = card.dataset.type === "audio";
      const endpoint = isAudio ? `/audio/${secretId}/react` : `/secret/${secretId}/react`;

      // const floatingContainer = card.querySelector('.floating-lottie');
      const floating = document.createElement('div');
      floating.className = 'floating-lottie-animated';
      card.appendChild(floating);


      // === 1. EMOJI BURST AROUND BUTTON ===
      triggerEmojiBurst(btn, emojiChar);

      // === 2. 3D EXTRAS AROUND BUTTON ===
      if (type === 'cry') {
        const tear = document.createElement('span');
        tear.className = 'emoji-particle';
        tear.innerText = 'üíß';
        tear.style.setProperty('--x', '0px');
        tear.style.setProperty('--y', '50px');
        button.appendChild(tear);
        setTimeout(() => tear.remove(), 800);
      }

      if (type === 'gasp') {
        const puff = document.createElement('span');
        puff.className = 'emoji-particle';
        puff.innerText = 'üí®';
        puff.style.setProperty('--x', '-10px');
        puff.style.setProperty('--y', '0px');
        button.appendChild(puff);
        setTimeout(() => puff.remove(), 800);
      }


      try {
        const response = await fetch(endpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ type }),
        });

        const data = await response.json();

        const isHot = type === "hot";

        const animation = lottie.loadAnimation({
          container: floating,
          renderer: 'svg',
          loop: false,
          autoplay: true,
          path: animations[type]
        });

        // Get button to card offset
        const buttonRect = button.getBoundingClientRect();
        const cardRect = card.getBoundingClientRect();

        const startX = buttonRect.left - cardRect.left + buttonRect.width / 2;
        const startY = buttonRect.top - cardRect.top + buttonRect.height / 2;

        floating.style.left = `${startX}px`;
        floating.style.top = `${startY}px`;

        if (isHot) {
          floating.classList.add('no-spin');
        } else {

          // üéá TRAIL PARTICLES WHILE MOVING
          const trailEmojis = ['‚ú®', 'üí•', 'üí®'];
          let trailInterval = setInterval(() => {

            const trail = document.createElement('span');
            trail.className = 'trail-particle';
            trail.innerText = trailEmojis[Math.floor(Math.random() * trailEmojis.length)];

            // Offset from Lottie position
            const offsetX = (Math.random() - 0.5) * 60;
            const offsetY = (Math.random() - 0.5) * 60;

            trail.style.left = `${floating.offsetLeft}px`;
            trail.style.top = `${floating.offsetTop}px`;
            trail.style.setProperty('--trail-x', `${offsetX}px`);
            trail.style.setProperty('--trail-y', `${offsetY}px`);

            card.appendChild(trail);
            setTimeout(() => trail.remove(), 600);
          }, 100);

          // üéØ Animate to center
          setTimeout(() => {
            floating.classList.add('to-center');
          }, 50);

          // üëã Animate back and remove
          setTimeout(() => {
            floating.classList.remove('to-center');
            floating.classList.add('to-button');
            clearInterval(trailInterval);
          }, 1200);

          setTimeout(() => {
            floating.remove();
          }, 1800);
        }

        if (data.success) {
          const countSpan = btn.querySelector(".reaction-count");
          const newCount = data.reactions[type].count || 0;
          animateCountBump(countSpan, newCount);
          btn.classList.add("bounce");
          setTimeout(() => btn.classList.remove("bounce"), 300);

          // Use updated count from server
        } else {
          console.error("Failed to update reactions:", data.error);
        }
      } catch (error) {
        console.error("Error updating reactions:", error);
      }

      function animateCountBump(countSpan, newCount) {
        const temp = document.createElement("span");
        temp.className = "reaction-count";
        temp.textContent = newCount;
        // temp.style.position = "absolute";
        temp.style.transform = "translateY(100%)";
        // temp.style.transition = "transform 0.3s ease";

        const wrapper = countSpan.parentElement;
        wrapper.appendChild(temp);

        requestAnimationFrame(() => {
          countSpan.style.transform = "translateY(-100%)";
          temp.style.transform = "translateY(0%)";
        });

        setTimeout(() => {
          countSpan.remove();
        }, 300);
      }



      function triggerEmojiBurst(container, emojiChar) {
        const burstCount = 20;

        for (let i = 0; i < burstCount; i++) {
          const particle = document.createElement('span');
          particle.classList.add('emoji-particle');
          particle.innerText = emojiChar;

          const angle = Math.random() * 2 * Math.PI;
          const distance = Math.random() * 40 + 20;
          const x = Math.cos(angle) * distance + 'px';
          const y = Math.sin(angle) * distance + 'px';

          particle.style.setProperty('--x', x);
          particle.style.setProperty('--y', y);

          container.appendChild(particle);
          setTimeout(() => particle.remove(), 800);
        }

        container.classList.add('pop-animate');
        setTimeout(() => container.classList.remove('pop-animate'), 300);
      }
    }

    if (e.target.closest(".card-toggle-btn")) {
      const button = e.target.closest(".card-toggle-btn")
      button.addEventListener("click", (e) => {
        const menuContent = e.target.closest(".card-menu").querySelector(".card-menu-content");
        const isVisible = menuContent.style.display === "block";

        // Hide all others
        document.querySelectorAll(".card-menu-content").forEach((menu) => {
          menu.style.display = "none";
        });

        // Toggle this one
        menuContent.style.display = isVisible ? "none" : "block";

        e.stopPropagation(); // Prevent auto-close
      });

    }

    const shareBtn = e.target.closest(".share-btn");

    if (shareBtn) {
      const card = shareBtn.closest(".card");
      const username = "<%= username %>";
      const link = `https://gossipa.app/gist/abc123?ref=${encodeURIComponent(username)}`;
      const shareModal = card.querySelector(".share-modal")

      card.querySelector(".share-link").value = link;
      card.querySelector(".share-twitter").href =
        `https://twitter.com/intent/tweet?text=${encodeURIComponent("Check out this gist on Gossipa! " + link)}`;
      card.querySelector(".share-whatsApp").href =
        `https://wa.me/?text=${encodeURIComponent("üî• Check this gist: " + link)}`;
      card.querySelector(".share-snapchat").href =
        `https://snapchat.com/scan?attachmentUrl=${encodeURIComponent("üî• Check this gist: " + link)}`
      card.querySelector(".share-messenger").href =
        `fb-messenger://share?link=${encodeURIComponent(link)}`;

      shareModal.style.display = "flex";
    }

    const closeBtn = e.target.closest(".close-share-modal")

    if (closeBtn) {
      const card = closeBtn.closest(".card");
      const shareModal = card.querySelector(".share-modal")
      shareModal.style.display = "none";
    }


    const shareLink = e.target.closest(".copy-link");

    if (shareLink) {
      const notice = document.getElementById("notification")
      const card = shareLink.closest(".card");
      const input = card.querySelector(".share-link");
      input.select();
      document.execCommand("copy");
      const btn = card.querySelector(".copy-link");
      btn.textContent = "Copied ‚úÖ";
      btn.disabled = true;
      notice.innerHTML = `<div class="toast">Link copied! üéØ Now share it!</div>`;
      setTimeout(() => {
        notice.innerHTML = ""
        btn.textContent = "Copy"
        btn.disabled = false;

      }, 2000);
    }



    if (e.target.closest(".card-menu-content")) {
      e.stopPropagation();
    }


    if (e.target.closest(".report-btn")) {
      const btn = e.target.closest(".report-btn");

      e.stopPropagation(); // Prevent closing menu before prompt

      const secretId = e.target.closest(".report-btn").getAttribute('data-id');
      const reason = prompt('Why are you reporting this content?');

      if (reason) {
        try {
          const response = await fetch(`/report/secret/${secretId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ reason })
          });

          const data = await response.json();
          if (data.success) {
           
            showToast("Thank you for reporting. We will review it shortly.;")

            document.querySelectorAll(".card-menu-content").forEach((menu) => {
              menu.style.display = "none";
            });
          } else {
            showToast("Error reporting content")
          }
        } catch (error) {
          console.error('Error reporting:', error);
        }
      }
    }

    const deleteBtn = e.target.closest(".delete");

    if (deleteBtn) {
      e.preventDefault();

      const secretCard = deleteBtn.closest(".secret")
      const card = secretCard.querySelector(".card");
      const postIdEl = secretCard.querySelector("#secId") || secretCard.querySelector("#audioId");
      const postId = postIdEl ? postIdEl.value : null;


      const postType = secretCard.dataset.type;
      console.log(postType)
      let endpoint;
      if (postType === "text") {
        endpoint = "/delete";
      } else if (postType === "audio") {
        endpoint = "/audio-delete";
      } else {
        console.error("Unknown post type:", postType);
        return;
      }


      if (confirm("Are you sure you want to delete this gist?")) {
        try {

          const response = await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ postId })
          });

          const data = await response.json();

          console.log(data)

          if (data.success) {
            showToast(data.message)
            secretCard.remove()
          } else {
            showToast(data.error)
          }
        } catch (error) {
          console.error('Error deleting gist', error);
        }
      } else {
        e.preventDefault();
      }

    }



    if (e.target.closest(".read")) {
      const button = e.target.closest(".read")

      const contentSpan = e.target.previousElementSibling;
      const isTruncated = e.target.textContent === "Read More";

      if (isTruncated) {
        // Show full content
        contentSpan.textContent = e.target.dataset.full;
        e.target.textContent = "See Less";
      } else {
        // Reapply truncated content
        contentSpan.textContent = e.target.dataset.truncated;
        e.target.textContent = "Read More";
      }
    }

  })


  // Hide all menus on body click
  document.addEventListener("click", () => {
    document.querySelectorAll(".card-menu-content").forEach((menu) => {
      menu.style.display = "none";
    });
  });

</script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    fetchComment()
  });
</script>

<script>
  document.addEventListener("DOMContentLoaded", async () => {
    const parent = document.querySelector("#userPostsContainer");

    // Bubble for clicks (toggle comment dropdown + translate)
    parent.addEventListener("click", async (e) => {
      // Toggle comment dropdown
      if (e.target.closest("#commentButton")) {
        const section = e.target.closest(".comment-section");
        const postType = section.closest(".secret").dataset.type;
        const postId = section.querySelector("#secretId")?.value || section.querySelector("#audioId")?.value;
        const dropdown = section.querySelector(".comment-dropdown");

        const display = section.querySelector(".comment-display");
        const commentList = display.querySelector(".comments-list");
        const totalcomments = display.querySelector("total");
        const count = section.querySelector(".comment-count");

        dropdown.classList.toggle("active");

        if (dropdown.classList.contains("active")) {
          // üëâ Show shimmer while fetching
          commentList.innerHTML = `
      <ul class="shimmer-comments">
        ${Array(3).fill(0).map(() => `
          <li class="comment-item shimmer-bubble">
            <div class="avatar shimmer-circle"></div>
            <div class="bubble shimmer-rect"></div>
          </li>
        `).join("")}
      </ul>
    `;


          try {
            const commentsRes = await fetch(`/comment/${postType}/${postId}`);
            const data = await commentsRes.json();
            const comments = data.comments || [];

            const commentHead = data.totalComments > 0
              ? `<p class="total">All comments: <span class="total-count">${data.totalComments} </span></p>`
              : `<p class="total">Share your thought</p>`;

            display.querySelector(".total")?.remove();
            display.insertAdjacentHTML("afterbegin", commentHead);

            commentList.innerHTML = comments.map(comment =>
              `
        <li class="comment-item">
            <img src="${comment.profile_picture}" class="profile-pic thumb"/>
            <div>
            <small class="user">
              <strong>${comment.stealth_mode ? '@voice' + comment.user_id : comment.username}</strong>
              </small>
            <p class="comment">${comment.comment}</p>
            <button type="button" class="translate-btn" data-id="${comment.id}" data-text="${comment.comment}">Translate to english</button>
          <p class="translated-text" id="translated-${postId}-${comment.id}"></p>
          </div>
        </li>
      `).join("");

            // display.innerHTML = commentHead + commentList
            count.textContent = formatCount(data.totalComments);
          } catch (err) {
            console.error("Error loading comments:", err);
            display.innerHTML = `<p class="total">Failed to load comments</p>`;
          }

        }

        const icon = section.querySelector("#commentButton i");
        icon.className = dropdown.classList.contains("active")
          ? "fas fa-comment-slash"
          : "fas fa-comment";

      }

      // Handle Translate Button
      if (e.target.classList.contains("translate-btn")) {
        const btn = e.target;
        const section = btn.closest(".comment-section");
        const postId = section.dataset.postId;
        const text = btn.dataset.text;
        const id = btn.dataset.id;
        const output = section.querySelector(`#translated-${postId}-${id}`);

        output.innerText = "Translating...";

        try {
          const res = await fetch("/translate", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ text, targetLang: "en" }),
          });
          const result = await res.json();
          output.innerText = result.translated || "Translation failed.";
        } catch (err) {
          output.innerText = "Error translating comment.";
        }
      }
    });

    // Bubble for comment form submission
    parent.addEventListener("submit", async (e) => {
      if (e.target.closest("#comment-form")) {
        e.preventDefault();
        const form = e.target;
        const section = form.closest(".comment-section");
        const postType = section.closest(".secret").dataset.type;
        const postId = section.querySelector("#secretId")?.value || section.querySelector("#audioId")?.value;

        const secretUserId = form.querySelector('[name="secretUserId"]').value;
        const commentUserId = form.querySelector('[name="commentUserId"]').value;
        const commentInput = form.querySelector("#commentInput").value;

        const display = section.querySelector(".comment-display");
        const commentList = section.querySelector(".comments-list");
        const totalcomments = display.querySelector("total-count");
        const count = section.querySelector(".comment-count");

        try {
          const res = await fetch(`/comment/${postType}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              id: postId,
              secretUserId,
              commentUserId,
              comment: commentInput
            }),
          });

          const result = await res.json();

          if (result.success) {
            const commentsRes = await fetch(`/comment/${postType}/${postId}`);
            const data = await commentsRes.json();
            const comments = data.comments || [];


            const commentHead = `<p class="total">All comments: <span class="total-count">${data.totalComments}</span></p>`;

            display.querySelector(".total")?.remove();
            display.insertAdjacentHTML("afterbegin", commentHead);

            commentList.innerHTML = comments.map(comment => `
<li class="comment-item">
            <img src="${comment.profile_picture}" class="profile-pic thumb"/>
              <div>
            <small class="user">
              <strong>${comment.stealth_mode ? '@voice' + comment.user_id : comment.username}</strong>
              </small>
            <p class="comment">${comment.comment}</p>
            <button type="button" class="translate-btn" data-id="${comment.id}" data-text="${comment.comment}">Translate to english</button>
<p class="translated-text" id="translated-${postId}-${comment.id}"></p>
          </div>
</li>
`).join("");
            count.textContent = formatCount(data.totalComments);
            form.querySelector("#commentInput").value = "";
          } else {
            showToast("Failed to post comment")
          }
        } catch (err) {
          console.error(err);
          showToast("Error posting comment")
        }
      }
    });
  });
</script>

<script>
  dayjs.extend(window.dayjs_plugin_relativeTime);

  document.querySelectorAll('.timestamp').forEach((timeElem) => {
    const rawTimestamp = timeElem.getAttribute('data-raw');
    if (rawTimestamp) {
      const formatted = dayjs(rawTimestamp).fromNow();
      timeElem.textContent = formatted;
    }
  });
</script>


<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Simulate a short loading delay (optional)
    setTimeout(() => {
      // Hide shimmer placeholder
      document.getElementById("shimmer-container").style.display = "none";
      // Show real secrets
      document.getElementById("real-secrets").style.display = "block";
    }, 1000); // 1s delay ‚Äì tweak as needed
  });
</script>


<script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.0/lottie.min.js"></script>