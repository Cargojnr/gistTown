<style>
  .container {
    padding: 0 !important;
  }

  #recordContainer {
    position: relative;
    background: linear-gradient(135deg, #1e3c72, #2a5298);
    /* background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); */
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    height: 45vh;
    text-align: center;
    padding: 30px;
    margin: 1rem;
    border-radius: 15px;
    backdrop-filter: blur(10px);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    color: var(--text-color);
  }

  h1 {
    margin-bottom: 20px;
    font-size: 24px;
  }


  .mic-button {
    /* background: #ff5f6d; */
    background: var(--secondary-color);
    border: none;
    color: white;
    width: 80px;
    height: 80px;
    border-radius: 50%;
    font-size: 24px;
    cursor: pointer;
    transition: background 0.3s ease;
    position: relative;
  }

  .mic-button:active {
    background: #ff3b4a;
  }

  .mic-button.recording {
    animation: glow 1.5s infinite;
  }

  @keyframes glow {
    0% {
      box-shadow: 0 0 10px #ff5f6d, 0 0 20px #ff5f6d, 0 0 30px #ff5f6d;
    }

    50% {
      box-shadow: 0 0 20px #ff5f6d, 0 0 30px #ff5f6d, 0 0 40px #ff5f6d;
    }

    100% {
      box-shadow: 0 0 10px #ff5f6d, 0 0 20px #ff5f6d, 0 0 30px #ff5f6d;
    }
  }

  #actionButtons {
    display: none;
    margin-top: 20px;
  }

  #actionButtons button {
    padding: .5rem .75rem;
    border-radius: 5px;
    border: none;
  }

  audio {
    margin-top: 20px;
    width: 100%;
    max-width: 600px;
  }

  .submit {
    border: none;
    background: transparent;
    color: var(--secondary-color);
    padding: .75rem 1rem;
    font-size: 2.75rem !important;
  }

  .post-action {
    position: absolute;
    right: 0%;
    bottom: 5% !important;
  }


  .custom-dropdown {
    position: relative;
    display: inline-block;
  }

  .custom-dropdown button {
    background: transparent;
    border: none;
    cursor: pointer;
    font-size: 1.2rem;
    color: var(--text-color);
  }

  .dropdown-options {
    position: absolute;
    top: 120%;
    left: 0;
    align-items: flex-start;
    flex-direction: column;
    background: #fff;
    border: 1px solid #ddd;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
    border-radius: 8px;
    list-style: none;
    padding: 0.5rem 0;
    z-index: 999;
    min-width: 150px;
    animation: fadeIn 0.2s ease;
  }

  .dropdown-options li {
    padding: 0.6rem 1rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: flex-start;
    font-size: 0.95rem;
  }

  .dropdown-options li:hover {
    background: #f5f5f5;
  }

  .dropdown-options .fa-check {
    margin-right: 8px;
    color: green;
  }

  .invisible-check {
    visibility: hidden;
  }

  .dropdown-options .selected .fa-check {
    visibility: visible;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(-5px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .user-details {
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: .5rem;
  }


  .hidden {
    display: none !important;
  }
</style>



<div class="container">
  <div class="jumbotron text-center form-wrapper">
    <div class="form-wrap">
      <div class="form-transition-container">
        <!-- TEXT FORM -->
        <div id="textForm" class="toggle-form">
          <form id="textSubmitForm" method="post">
            <div class="user-details">
              <a href="" class="avatar-profile thumb">
                <img src="../.<%= profilePicture %>" alt="" class="profile pic thumb">
              </a>

              <div class="custom-dropdown">
                <button id="visibilityToggle" type="button">
                  <abbr title="Views"><i class="fas fa-earth-africa"></i>
                  <span class="nav-text">For All Gossipas</span>
                  <span><i class="fas fa-chevron-down nav-icon"></i></span>
                </abbr>
                </button>
                <ul id="visibilityOptions" class="dropdown-options" hidden>
                  <li data-value="public" class="selected"><i class="fas fa-check"></i> For All</li>
                  <li data-value="exclusive"><i class="fas fa-check invisible-check"></i> For Chiefs</li>
                  <li data-value="private"><i class="fas fa-check invisible-check"></i> For Myself Only</li>
                </ul>
              </div>
            </div>

            <textarea id="postInput" name="secret" class="input-text"
              placeholder="Hey <%= username %> What's on your mind today!"></textarea>

            <div class="post-action">
              <p class="word-count"><span id="wordCount">0</span></p>
              <button type="submit" id="share" class="create submit">
                <i class="fas fa-paper-plane"></i>
              </button>
            </div>
          </form>
        </div>

        <!-- AUDIO FORM -->
        <div id="audioForm" class="toggle-form hidden">
          <div class="user-details">
            <a href="" class="avatar-profile thumb">
              <img src="../.<%= profilePicture %>" alt="" class="profile pic thumb">
            </a>

            <div class="custom-dropdown">
              <button id="visibilityToggle" type="button">
                <abbr title="Views"><i class="fas fa-earth-africa"></i></abbr>
                <span class="nav-text">For All Gossipas</span>
                <span><i class="fas fa-chevron-down nav-icon"></i></span>
              </button>
              <ul id="visibilityOptions" class="dropdown-options" hidden>
                <li data-value="public" class="selected"><i class="fas fa-check"></i> For All</li>
                <li data-value="exclusive"><i class="fas fa-check invisible-check"></i> For Chiefs</li>
                <li data-value="private"><i class="fas fa-check invisible-check"></i> For Myself Only</li>
              </ul>
            </div>
          </div>

          <div id="recordContainer">
            <h1>Record a Voice Note</h1>
            <button id="micButton" class="mic-button"><i class="fas fa-microphone"></i></button>

            <audio id="audioPlayer" controls style="display:none;"></audio>

            <div class="voicewave">

            </div>
          </div>

          <div id="actionButtons" class="post-action">
            <button id="discardRecording">Discard</button>
            <button id="submitRecording" class="create submit"><i class="fas fa-paper-plane"></i></button>
          </div>
        </div>

      </div>

      <div class="actions">
        <button type="button" onclick="showTextForm()"><i class="fas fa-pen-to-square"></i></button>
        <button type="button" onclick="showAudioForm()" class="create"><i class="fas fa-microphone"></i></button>
      </div>

    </div>
  </div>

</div>
<audio id="post-sound" src="/sounds/whoosh-6316.mp3" preload="auto"></audio>

</div>
</div>

<script>

  const toggleViewBtn = document.getElementById("visibilityToggle");
  const dropdown = document.getElementById("visibilityOptions");

  toggleViewBtn.addEventListener("click", (e) => {
    // e.preventDefault()
    const isOpen = dropdown.hasAttribute("hidden") === false;
    dropdown.hidden = isOpen;
    toggleViewBtn.setAttribute("aria-expanded", String(!isOpen));
  });

  dropdown.addEventListener("click", (e) => {
    const selected = e.target.closest("li");
    if (!selected) return;

    // Mark selected
    dropdown.querySelectorAll("li").forEach(li => {
      li.classList.remove("selected");
      li.querySelector("i").classList.add("invisible-check");
    });

    selected.classList.add("selected");
    selected.querySelector("i").classList.remove("invisible-check");

    dropdown.hidden = true;
    toggleViewBtn.setAttribute("aria-expanded", "false");

    // Use value if needed
    const visibility = selected.dataset.value;
    console.log("Selected:", visibility);
  });

</script>


<script>

  // Handle form submission via Fetch API
  document.getElementById('textSubmitForm').addEventListener('submit', async (event) => {
    event.preventDefault(); // Prevent form's default redirect behavior
    
    const notice = document.getElementById("notification")
    const secretInput = document.querySelector('[name="secret"]');
    const categoryDropdown = document.getElementById('category');
    const secret = secretInput.value;
    const category = document.querySelector('#visibilityOptions .selected')?.dataset.value || "public";

    if (!category) {
      alert('Please select a category before sharing!');
      return;
    }

    if (!secret) {
            if (notice) {
              notice.innerHTML = `<div class="toast">You can't submit an empty gist!</div>`;
              setTimeout(() => (notice.innerHTML = ""), 3000);
            }
            return;
          }

    try {
      const response = await fetch('/share', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          secret,
          category,
          contentType: 'text' // Indicate that this is a text submission
        }),
      });

      const data = await response.json();

      if (data.success) {
        alert('Secret shared successfully!');
        secretInput.value = ''; // Clear the input field
      } else {
        alert('Failed to share the secret. Please try again.');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('An error occurred. Please try again later.');
    }
  });
</script>


<script src="../../js/app.js"></script>
<% if (locals.theme) { %>
  <script src="../../js/theme.js"></script>
  <% } else {%>
    <script src="../../js/defaultTheme.js"></script>
    <% } %>